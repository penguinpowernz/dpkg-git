#!/bin/bash

usage() {
  echo "Usage: dpkg-git <action> <repo> [path]

  Actions:
      -i      install the package from the path
      -b      build the package from the path

  Repo:
      The repo is a local repository but it must 
      contain valid Debian control files
      
      /path/to/repo
      git://github.com/penguinpowernz/dpkg-git.git
      https://github.com/penguinpowernz/dpkg-git.git
      http://github.com/penguinpowernz/dpkg-git.git

  Path:
      The path refers to a place in which to save
      the debian file to (-b only)

"

}

BIN="/usr/share/dpkg-git/bin";
ACTION=$1;

# Clone the repo first, if it is a cloneable path
if [ "$(echo "$2"|grep -P "^http[s]?://|^git://"|wc -l)" = "1" ]; then
  TMP="/tmp/src/$(basename $2)";
  git clone "$2" "$TMP";
  SRCDIR="$TMP";
else
  SRCDIR="$2";
fi;

case "$ACTION" in
  "-i")
    deb="$($BIN/dpkg-git-build.sh "$SRCDIR" /var/cache/dpkg-git/debs)";
    sudo dpkg -i $deb;
    ;;
  "-b") $BIN/dpkg-git-build.sh "$SRCDIR" "$3";;
  *) usage ;;
esac;

exit 0;